## 线索数如何混合进入模型，提升建模预测的准确性的。

**数据流与合并**

- 发现最新线索文件：`find_latest_leads_daily()` 搜索 `processed/leads_daily_*.csv` 取按修改时间最新。
- 读取与标准化：`load_leads_daily()` 解析 `date` 并识别“线索识别数”列（候选：`线索识别数`、`识别数`、`leads_count`、`线索数` 等；若缺失则选首个数值列），输出两列：`date`、`leads_recognition_count`。
- 日期对齐合并：`merge_leads_features()` 将 `leads_recognition_count` 按 `date` 左连接到每日订单表，缺失填充为 0。
- 训练段构造：`compute_daily_counts_for_group()` 按车型与时间窗汇总 `count`，并在返回的数据框里合并线索列，以便后续特征工程。

**特征工程（含线索）**

- 时间特征：`add_time_features()` 在每日表上生成 `day_of_week`、`is_weekend`、`lag_1/2/3`（订单滞后）与 `cum_7`（7 日订单累计）。
- 线索特征：同函数内生成
  - `leads_lag_1`、`leads_lag_2`、`leads_lag_3`：线索识别数的 1/2/3 日滞后。
  - `leads_cum_7`：近 7 日线索识别数累计。
- 相位与截止天：用 `cycle_day` 归一化得到 `phase` 与 `days_to_deadline_norm`，用于刻画周期内的双峰形状。

**建模整合方式**

- 基线分离：`build_normalized_baseline()` 将 CM1/CM2 历史段归一化到统一相位空间并平均，构造双峰基线；`make_baseline_for_cycle_days()` 重采样到目标周期天数。
- 残差学习：`orchestrate_training()` 构造训练样本，计算 `residual = y - baseline`，用 Boosting（XGBoost 或 `GradientBoostingRegressor`）拟合残差。
- 训练特征集合：`feat_cols` 显式包含线索特征
  - `leads_lag_1`、`leads_lag_2`、`leads_lag_3`、`leads_cum_7`
  - 以及订单滞后与日历特征：`lag_1/2/3`、`cum_7`、`day_of_week`、`is_weekend`、`model_group_code`、`phase`、`days_to_deadline_norm`
- 作用机理：基线解释“形状”，线索特征作为外生驱动解释基线之外的日级波动（如营销拉升、识别强度峰值），提升对峰谷与短期振幅的拟合能力。

**预测阶段如何使用线索**

- 已知天（前 1 ～ 3 日）：`predict_new_series()` 接收包含 `date`、`count`、`leads_recognition_count` 的 `initial_daily`，将这几天的线索作为后续滞后和累计的基础。
- 未知天（第 4 ～ X 日）：构造特征时
  - 订单滞后与累计：用已知天的 `count` 计算 `lag_1/2/3` 与 `cum_7`。
  - 线索滞后与累计：用已知天的 `leads_recognition_count` 计算 `leads_lag_1/2/3` 与 `leads_cum_7`（未知位置视为 0，不进行未来信息假设），避免未来信息泄露。
- 组合输出：模型预测残差后与对应 `baseline[i]` 相加并截断到非负，得到每日预测值。

**为什么线索能提升准确性**

- 更强的外生解释力：线索识别数反映市场触达与漏斗上游活跃度，常与当天或次日的订单量相关；滞后与累计特征捕捉“滞后影响”和“短期累积效应”，解释基线难以刻画的短周期波动。
- 峰值定位与强度：在训练段中，线索累计与滞后能帮助模型更准确地定位与量化峰值位置与强度，从而在残差空间提升拟合。
- 稳健性：预测时仅使用已知线索（前 1 ～ 3 日），避免依赖未来信息；当未知期线索不可得时，模型仍可依赖订单的滞后与日历特征输出稳定预测。

**从报告的印证**

- 例：`2025-09-09` 与 `2025-09-10` 的“线索识别数”分别为 `24897`、`45465`，对应订单峰值 `8060`、`15322`。线索特征让模型更易在残差拟合中识别并提升这些高波动日的预测。

**可进一步优化的点**

- 一致的“只看过去”策略：当前训练阶段的 `cum_7` 与 `leads_cum_7`使用了“含当日”滚动；预测阶段的累计仅用过去值。为避免训练-预测特征分布不一致，建议改为在训练阶段使用 `.shift(1).rolling(...).sum()`，使累计严格基于前一日及更早数据。
- 线索的未来估计：若需要在第 4 ～ X 日持续使用线索驱动，可加入简单的线索预测（如上周同日、最近 7 日均值或外部计划表），再作为外生输入构造 `leads_lag_*` 与 `leads_cum_7`。
- 分车型/分渠道线索：如果线索能按车型或渠道细分，进一步提升特征的针对性，减少噪声。

如需我把训练阶段的累计特征改为严格使用“过去数据”（避免含当日导致的信息泄露），或为未知期加入可选的线索预测策略（如周均或同周同日模式），我可以直接在脚本中调整并给出一次验证报告。

---

【新车型预测】
车型=LS9，起始=2025-11-04，累计周期=9 天
【已知值（前 1 ～ 3 日）】

- 第 1 日(2025-11-04): 3665（线索识别数=36345）
- 第 2 日(2025-11-05): 1033（线索识别数=31951）
- 第 3 日(2025-11-06): 483（线索识别数=22893）
  【预测（第 4 ～ X 日）】
- 第 4 日(2025-11-07): 747
- 第 5 日(2025-11-08): 402
- 第 6 日(2025-11-09): 980
- 第 7 日(2025-11-10): 349
- 第 8 日(2025-11-11): 1500
- 第 9 日(2025-11-12): 6608
